---
tags:
  - db
  - clickhouse
---
## Колонночное хранение данных

Клик является _колонночной_ базой данных: данные хранятся по столбцам, а не построчно ([Обзор архитектуры | ClickHouse Docs](https://clickhouse.com/docs/ru/development/architecture#:~:text=ClickHouse%20%E2%80%93%20%D1%8D%D1%82%D0%BE%20%D0%B8%D1%81%D1%82%D0%B8%D0%BD%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BE%D0%BB%D0%BE%D0%BD%D0%BE%D1%87%D0%BD%D0%B0%D1%8F,%D1%81%D0%BD%D0%B8%D0%B7%D0%B8%D1%82%D1%8C%20%D1%81%D1%82%D0%BE%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D1%8C%20%D1%84%D0%B0%D0%BA%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B9%20%D0%BE%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B8%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)). Это означает, что значения каждого столбца физически располагаются последовательными блоками на диске, отдельно от других столбцов. Такой подход дает несколько преимуществ:
- **Чтение только нужных столбцов:** При выполнении запроса бд считывает с диска только те колонки, которые участвуют в запросе, игнорируя остальные ([Обзор архитектуры | ClickHouse Docs](https://clickhouse.com/docs/ru/development/architecture#:~:text=ClickHouse%20%E2%80%93%20%D1%8D%D1%82%D0%BE%20%D0%B8%D1%81%D1%82%D0%B8%D0%BD%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BE%D0%BB%D0%BE%D0%BD%D0%BE%D1%87%D0%BD%D0%B0%D1%8F,%D1%81%D0%BD%D0%B8%D0%B7%D0%B8%D1%82%D1%8C%20%D1%81%D1%82%D0%BE%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D1%8C%20%D1%84%D0%B0%D0%BA%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B9%20%D0%BE%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B8%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)). В результате система избегает чтения лишних данных и тратит меньше времени на ввод-вывод, что значительно ускоряет аналитические запросы по сравнению с построчным хранением.
- **Эффективное сжатие:** Однородность данных внутри каждого столбца позволяет применять к ним высокоэффективные алгоритмы сжатия. Значения сохраняются в _сжатых блоках_ размером обычно 64 КБ – 1 МБ несжатых данных ([Обзор архитектуры | ClickHouse Docs](https://clickhouse.com/docs/ru/development/architecture#:~:text=%D0%BF%D0%BE%20%D0%BA%D0%BE%D1%80%D1%82%D0%B5%D0%B6%D1%83%20%D0%BF%D0%B5%D1%80%D0%B2%D0%B8%D1%87%D0%BD%D0%BE%D0%B3%D0%BE%20%D0%BA%D0%BB%D1%8E%D1%87%D0%B0,%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B0%D0%B5%D1%82%D0%B5%20%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D1%8F%20%D0%B4%D0%BB%D1%8F%20%D1%81%D0%BE%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D1%81%D1%82%D0%B2%D1%83%D1%8E%D1%89%D0%B8%D1%85%20%D1%81%D1%82%D1%80%D0%BE%D0%BA)). Например, колонки с повторяющимися строками или небольшим числом различных значений могут быть сильно сжаты. Сжатие уменьшает объем хранимых данных и нагрузку на диск, что повышает пропускную способность системы.
- **Оптимизация CPU cache:** При обработке данных колонки читаются блоками (так называемыми _гранулами_ [[Гранула]]) по несколько тысяч значений, которые укладываются в кэш процессора. Это улучшает локальность доступа к памяти и уменьшает накладные расходы на загрузку данных в CPU.
**Итог:** Колонночное хранение идеально подходит для аналитических запросов. Чтение крупных последовательных блоков по одному столбцу уменьшает переходы между диском и памятью и сокращает число операций ио